# PROJECT TODO LIST

## WIP

- [ ] Унификация контекстов в игровых сущностях и интерфейсе

## TODO

### Улучшения и рефакторинг системы походов
- [ ] **Реализовать предбоевой экран для энкаунтеров**
    - [ ] **Изменить `game/ui/encounter_selection_screen.py`**:
        - Удалить вызов `context.encounter_manager.start_encounter(enc)` из действия команды выбора энкаунтера.
    - [ ] **Изменить `game/ui/encounter_screen.py`**:
        - **Управление состоянием**: Добавить флаг `self.battle_active = False` в `__init__`.
        - **Добавить метод `on_enter()`**:
            - Получать `current_encounter` из `encounter_manager`.
            - Логировать `current_encounter.description`.
            - Убедиться, что `self.battle_active` равно `False`.
            - Вызвать `self._setup_commands()` для настройки предбоевого состояния.
        - **Метод `render()`**: Оставить без изменений (всегда отрисовывает боевой UI).
        - **Изменить метод `_setup_commands()`**:
            - Если `self.battle_active` равно `False`: Очистить команды. Зарегистрировать `LambdaCommand` для `Enter` (клавиша 10), которая устанавливает `self.battle_active = True`, а затем повторно вызывает `self._setup_commands()` для перехода в боевое состояние.
            - Если `self.battle_active` равно `True`: Очистить команды и зарегистрировать существующие боевые команды (включая `AttackCommand`).
        - **Метод `_setup_elements()`**: Оставить без изменений (всегда настраивает боевые панели).
- [ ] **EncounterManager:**
    - [ ] Загружать шаблоны походов из JSON-файлов вместо хардкода. - лучше, чтобы походы генерировались рандомные, основываясь на текущих уровнях персонажей с небольшим разбросом
    - [ ] Реализовать логику наград за победу и последствий поражения в `_end_encounter`. логика наград реализована отдельно за бой. нет смысла делать ее еще и для энкаунтера
    - [ ] Упростить и объединить методы `init_encounter` и `start_encounter`.
- [ ] **EncounterSelectionScreen:**
    - [ ] Упростить создание команд, чтобы избежать сложной логики с замыканиями.
    - [ ] Сделать логику запуска похода более явной (вызывать один метод в `EncounterManager`).
- [ ] **EncounterScreen:**
    - [ ] Уменьшить зависимость от `EncounterManager`, передавая данные о событии напрямую.
    - [ ] Реализовать обработку и отображение новых типов событий (например, `DialogueEvent`).
- [ ] **GameManager:**
    - [ ] Удалить или переработать метод `_create_initial_enemies`, чтобы он не конфликтовал с логикой походов.

### Система походов (Encounters)
- [x] **Архитектура и базовые классы:**
    - [x] Создать директорию `game/systems/encounters` для всей логики системы.
    - [x] Создать `game/systems/encounters/encounter.py` с датаклассом `Encounter`.
    - [x] Создать `game/systems/encounters/events.py` с базовым классом `EncounterEvent` и наследником `BattleEncounterEvent`.
- [x] **Менеджер походов:**
    - [x] Создать `game/systems/encounters/encounter_manager.py` с классом `EncounterManager`.
    - [x] Реализовать метод `generate_encounters` в `EncounterManager`.
    - [x] Реализовать `start_encounter` и логику управления состоянием в `EncounterManager`.
- [x] **Интеграция с UI:**
    - [x] Переименовать `game/ui/battle_screen.py` в `game/ui/encounter_screen.py`.
    - [x] Обновить `EncounterScreen` для обработки разных типов событий (`BattleEncounterEvent`, `DialogueEvent`).
    - [x] Реализовать динамическую смену команд в `EncounterScreen`.
    - [x] Создать `EncounterSelectionScreen` для выбора похода.
    - [x] Добавить команду на `MainScreen` для перехода к выбору похода.
- [x] **Интеграция с GameManager:**
    - [x] Добавить `EncounterManager` в `GameManager`.
    - [x] Реализовать взаимодействие между `EncounterManager` и `GameManager` для запуска боев и обработки их завершения.

### Общее

- [ ] Интеграция AI контроллера в цикл боя
- [ ] Реализация системы статус-эффектов
- [ ] Создание фабрики действий на основе конфигурации
- [ ] Реализация сложного AI с оценкой действий
- [ ] Сделать централизованный обработчик ошибок
- [ ] Сделать централизованный логгер

### Пользовательский Интерфейс

- [ ] Доработать `EncounterScreen.render`, чтобы он обновлял содержимое `UnitPanel` (имя, HP, MP) на основе данных из `GameManager` перед отрисовкой панелей.
- [ ] Проверить и доработать логику `_update_component_sizes` в `EncounterScreen` для корректной обработки изменения размеров компонентов при ресайзе окна терминала.

### Компоненты UI

- [ ] Проверить корректность работы прокрутки `BattleLog` (`scroll_up`, `scroll_down`) и отображения большого количества сообщений.
- [ ] Добавить отображение дополнительной информации в `UnitPanel` (статусные эффекты).
- [ ] Убедиться, что отрисовка (`render`) всех компонентов корректно обрабатывает выход за границы экрана (`curses.error`).

### Данные

- [ ] Убедиться, что все необходимые JSON-файлы (игроки, монстры) существуют и корректны.
- [ ] Проверить и доработать `character_loader.py` для корректной обработки всех полей из JSON (например, `abilities`, если структура сложнее).

### Система Команд

- [ ] Завершить рефакторинг системы команд (`Command System`) согласно ранее обсужденным идеям (регистрация, контекст).
- [ ] Добавить команды для `EncounterScreen` (например, выбор цели, использование атаки/зелья).

### Тестирование

- [ ] Написать тесты для `game/config.py` (загрузка, значения по умолчанию, обработка ошибок).
- [ ] Написать тесты для `game/data/character_loader.py` (успешная загрузка, обработка отсутствующих файлов, некорректного JSON).
- [ ] Написать тесты для `game/naming/monster_namer.py` (если используется отдельно от `TemplateMonsterNamer`).
- [ ] Написать тесты для фабрик в `game/factories/` (`PlayerFactory`, `MonsterFactory` - корректное создание объектов из данных).
- [ ] Написать тесты для `game/ui/main_screen.py` (логика главного экрана, отрисовка, команды).
- [ ] Написать тесты для `game/ui/inventory_screen.py` (логика экрана инвентаря, отрисовка, команды).
- [ ] Написать тесты для `game/ui/battle_screen.py` (логика обновления данных, отрисовка компонентов, обработка команд боя).
- [ ] Проверить и расширить тесты для компонентов UI в `game/ui/widgets` и `game/ui/components` (`UnitPanel`, `GroupPanel`, `BattleLog`, `TextLabel`, `ProgressBar` - граничные условия, взаимодействие, отрисовка).
- [ ] Добавить тесты в `tests/test_ui/test_command_system.py` для проверки поведения абстрактного метода `Command.execute` (например, что он требует реализации или корректно аннотирован).
- [ ] Добавить интеграционные тесты для проверки работы экранов с реальным `GameManager`, фабриками и рендерером (возможно, с моками `curses`).
- [ ] Добавить тесты для интеграции `GameManager` с фабриками и UI.

### Документация/Кодстайл

- [ ] Добавить и проверить docstrings для новых и измененных классов и методов.
- [ ] Убедиться, что весь код соответствует PEP 8 и проходит `flake8`.

## DONE

- [x] Реализация базовой атаки и системы действий
- [x] Реализация логгера-подписчика
- [x] Реализация передачи данных от подписчика до UI компонента
- [x] Создание файла `PROJECT_TODO.md` и размещение его в корне проекта
- [x] Настройка в IDE отображения TODO из этого файла
- [x] Создание масштабируемой системы имен монстров
- [x] Интеграция реальных данных монстров в `EncounterScreen`. Связывание `EnemyGroupPanel` с `GameManager` для отображения состояния объектов `Character` (монстров), созданных фабрикой.
- [x] Добавление загрузки стартовых монстров в `GameManager._initialize_game_entities`, используя `monster_factory`.
- [x] Реализация механизма обновления UI (HP/MP) в `EncounterScreen` на основе текущего состояния объектов `Player`/`Character`.
- [x] Добавление в `GameManager` методов для управления текущими врагами (`get_current_enemies`, `set_current_enemies` и т.д.).
- [x] Создание JSON-файлов для классов монстров в `game/data/characters/monster_classes`.
- [x] `GameManager` отвечает за хранение и предоставление данных о текущих игроках и монстрах для экранов UI.
- [x] Реализация отображения имен монстров/игроков в `UnitPanel`.
- [x] Улучшение визуального представления `EncounterScreen`: корректное расположение игроков/монстров, настройка лога, порядок обрамления.
- [x] Написание тестов для `game/ui/base_screen.py`.
- [x] Реализация фабрик для создания игроков и монстров.
- [x] Создание базовой структуры `EncounterScreen` с компонентами (`UnitPanel`, `GroupPanel`, `BattleLog`).
- [x] Настройка базовой отрисовки `EncounterScreen` с использованием `Renderer`.